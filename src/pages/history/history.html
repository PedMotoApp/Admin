<ion-header class="bg-theme">
  <ion-navbar>
    <ion-title style="color: white; font-size: 16px;">
      {{ textHeader }}
    </ion-title>
  </ion-navbar>
</ion-header>

<ion-content class="page-history" style="background: #f4f5f8;">
  <ion-grid style="padding: 10px;">
    <!-- Filtros -->
    <form [formGroup]="formGroup" novalidate>
      <ion-row>
        <!-- Status -->
        <ion-col col-12 col-md-6>
          <ion-item no-lines style="background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <ion-label stacked style="font-weight: bold; color: #333;">Status</ion-label>
            <ion-select formControlName="status" (ionChange)="updateFilters()">
              <ion-option value="Todos">Todos</ion-option>
              <ion-option value="Criado">Criado</ion-option>
              <ion-option value="Aceito">Aceito</ion-option>
              <ion-option value="Finalizado">Finalizado</ion-option>
              <ion-option value="Cancelado">Cancelado</ion-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <!-- Cliente -->
        <ion-col col-12 col-md-6>
          <ion-item no-lines style="background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <ion-label stacked style="font-weight: bold; color: #333;">{{dataText.selectClient}}</ion-label>
            <ionic-selectable
              item-content
              formControlName="client"
              [items]="clientsWorkersArray"
              itemValueField="uid"
              itemTextField="email"
              [canSearch]="true"
              (onChange)="updateFilters()"
            >
            </ionic-selectable>
          </ion-item>
        </ion-col>

        <!-- Profissional -->
        <ion-col col-12 col-md-6>
          <ion-item no-lines style="background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <ion-label stacked style="font-weight: bold; color: #333;">{{dataText.selectProfessional}}</ion-label>
            <ionic-selectable
              item-content
              formControlName="worker"
              [items]="usersWorkersArray"
              itemValueField="uid"
              itemTextField="email"
              [canSearch]="true"
              (onChange)="updateFilters()"
            >
            </ionic-selectable>
          </ion-item>
        </ion-col>

        <!-- Data Inicial -->
        <ion-col col-12 col-md-6>
          <ion-item no-lines style="background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <ion-label stacked style="font-weight: bold; color: #333;">Data Inicial</ion-label>
            <ion-datetime
              formControlName="selectedDate"
              displayFormat="DD/MM/YYYY"
              (ionChange)="updateFilters()"
            ></ion-datetime>
          </ion-item>
          <ion-note margin-left ion-text color="danger" *ngIf="formGroup.get('selectedDate') && formGroup.get('selectedDate').invalid && formGroup.get('selectedDate').touched">
            {{dataText.requestdField}}
          </ion-note>
        </ion-col>

        <!-- Data Final -->
        <ion-col col-12 col-md-6>
          <ion-item no-lines style="background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <ion-label stacked style="font-weight: bold; color: #333;">Data Final</ion-label>
            <ion-datetime
              formControlName="selectedDateEnd"
              displayFormat="DD/MM/YYYY"
              (ionChange)="updateFilters()"
            ></ion-datetime>
          </ion-item>
          <ion-note margin-left ion-text color="danger" *ngIf="formGroup.get('selectedDateEnd') && formGroup.get('selectedDateEnd').invalid && formGroup.get('selectedDateEnd').touched">
            {{dataText.requestdField}}
          </ion-note>
        </ion-col>
      </ion-row>
    </form>

    <!-- Botões de Ação -->
    <ion-row>
      <ion-col col-12 col-md-6>
        <button ion-button block class="btn-action" (click)="showHistory()" *ngIf="!isReportOpen">
          Mostrar Histórico
        </button>
        <button ion-button block class="btn-action" (click)="showReport()" *ngIf="isReportOpen">
          Mostrar Relatórios
        </button>
      </ion-col>
      <ion-col col-12 col-md-6>
        <button ion-button block class="btn-action" (click)="downloadExcel()" *ngIf="!isReportOpen">
          Baixar Excel
        </button>
        <button ion-button block class="btn-action" (click)="backHistory()" *ngIf="isReportOpen">
          Voltar ao Histórico
        </button>
      </ion-col>
    </ion-row>

    <!-- Totais -->
    <ion-row *ngIf="!isReportOpen && worksArray && worksArray.length > 0">
      <ion-col col-12>
        <ion-card style="border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          <ion-item style="padding: 8px;">
            <div style="margin-left: 10px; flex: 1;">
              <h2 style="font-size: 16px; font-weight: bold; color: #333; margin: 0;">Totais</h2>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Total de Jobs:</b> {{totalJobs}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Distância Total:</b> {{totalDistance.toFixed(2)}} km</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Tempo Total:</b> {{totalTime.toFixed(2)}} min</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Preço Total:</b> R$ {{totalPrice.toFixed(2)}}</p>
            </div>
          </ion-item>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- Histórico -->
    <ion-row *ngIf="!isReportOpen">
      <ion-col col-12 col-md-6 *ngFor="let work of worksArray">
        <ion-card style="border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          <ion-item style="padding: 8px;" (click)="expand(work)">
            <ion-avatar item-start>
              <img src="./assets/imgs/default-user.png" *ngIf="!work.user?.photo" style="border-radius: 50%; width: 40px; height: 40px;">
              <img [src]="work.user?.photo" *ngIf="work.user?.photo" style="border-radius: 50%; width: 40px; height: 40px;">
            </ion-avatar>
            <div style="margin-left: 10px; flex: 1;">
              <h2 style="font-size: 14px; font-weight: bold; color: #333; margin: 0;">{{work.user?.email || dataText.notInformade}}</h2>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Data:</b> {{work.datetime}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Status:</b> {{work.status}}</p>
            </div>
            <ion-icon [name]="work.expand ? 'chevron-up' : 'chevron-down'" item-end style="color: #666; font-size: 14px;"></ion-icon>
          </ion-item>

          <!-- Detalhes Expansíveis -->
          <div *ngIf="work.expand" style="padding: 8px; background: #f9f9f9;">
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Profissional:</b> {{work.driver?.email || dataText.notInformade}}</p>
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Criado em:</b> {{work.createdAt}}</p>
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Finalizado em:</b> {{work.finalizedAt || dataText.notInformade}}</p>
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;" *ngIf="work.cancellationReason"><b>Motivo do Cancelamento:</b> {{work.cancellationReason}}</p>
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Distância Total:</b> {{work.servicesPrices?.totalDistance || 0}} km</p>
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Tempo Total:</b> {{work.servicesPrices?.totalTime || 0}} min</p>
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Preço Total:</b> R$ {{work.servicesPrices?.totalPrice || '0.00'}}</p>
            <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;" *ngIf="work.dropPoints && work.dropPoints.length > 0"><b>Pontos de Entrega:</b></p>
            <div *ngFor="let point of work.dropPoints">
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 10px;"><b>Endereço:</b> {{point.description || dataText.notInformade}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 10px;"><b>Chegada:</b> {{point.arrivedAt || dataText.notInformade}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 10px;"><b>Conclusão:</b> {{point.completedAt || dataText.notInformade}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 10px;"><b>Distância do Anterior:</b> {{point.distanceFromPrevious || 0}} km</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 10px;"><b>Tempo do Anterior:</b> {{point.timeFromPrevious || 0}} min</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 10px;" *ngIf="point.distanceToNext"><b>Distância até o Próximo:</b> {{point.distanceToNext}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 10px;" *ngIf="point.timeToNext"><b>Tempo até o Próximo:</b> {{point.timeToNext}}</p>
            </div>
          </div>          
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- Relatórios -->
    <ion-row *ngIf="isReportOpen">
      <ion-col col-12 col-md-6 *ngFor="let report of reportsArray">
        <ion-card style="border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          <ion-item style="padding: 8px;">
            <div style="margin-left: 10px; flex: 1;">
              <h2 style="font-size: 14px; font-weight: bold; color: #333; margin: 0;">Relatório</h2>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Data Início:</b> {{report.datetimeStart}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Data Fim:</b> {{report.datetimeEnd}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Total Jobs:</b> {{report.totalJobs}}</p>
              <p style="font-size: 12px; color: #666; margin: 2px 0 0 0;"><b>Total Final:</b> R$ {{report.totalFinal}}</p>
            </div>
          </ion-item>
          <ion-row style="padding: 0 8px 8px 8px;">
            <ion-col>
              <button ion-button icon-start clear small (click)="openDirect(report)">
                <ion-icon name="download" color="primary"></ion-icon>
                <div>Baixar</div>
              </button>
            </ion-col>
            <ion-col>
              <button ion-button icon-start clear small (click)="removeReport(report)">
                <ion-icon name="trash" color="danger"></ion-icon>
                <div>Remover</div>
              </button>
            </ion-col>
          </ion-row>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>